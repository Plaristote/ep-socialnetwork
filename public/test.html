<html>
<head>
  <title>E2E tests for Social Network</title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script type="text/javascript">

  var username = 'francis.poil7@gmail.com';

  function test_message_show(message_id) {
    $.ajax({
      method: 'GET',
      url: '/messages/' + message_id,
      dataType: 'json',
      success: function(data) {
        console.log("TEST test_message_show SUCCESS");
      },
      error: function(data) {
        console.log("TEST test_message_index FAILURE", data);
      }
    });
  }

  function test_message_index() {
    $.ajax({
      method: 'GET',
      url: '/messages',
      contentType: 'application/json',
      dataType: 'json',
      success: function (data) {
        if (data.messages.length > 0) {
          console.log("TEST test_message_index SUCCESS");
          test_message_show(data.messages[0].id);
        }
        else
          console.log("TEST test_message_index FAILURE", "no messages received");
      },
      error: function (data) {
        console.log("TEST test_message_index FAILURE", data);
      }
    });
  }

  function test_message_send() {
    $.ajax({
      method: 'POST',
      url: '/messages',
      data: JSON.stringify({ to: 34, message: 'Le message' }),
      contentType: 'application/json',
      dataType: 'json',
      success: function (data) {
        console.log("TEST test_message_send SUCCESS");
        test_message_index();
      },
      error: function (data) {
        console.log("TEST test_message_send FAILURE");
      }
    });
  }

  function test_session() {
    $.ajax({
      method: 'POST',
      url: '/session',
      data: JSON.stringify({ email: username, password: 'lepassword' }),
      contentType: 'application/json',
      dataType: 'json',
      success: function (data) {
        console.log('TEST test_session SUCCESS');
        test_message_send();
      },
      error: function (data) {
        console.log('TEST test_session FAILURE');
      }
    });
  }

  function test_unauthorized() {
    $.ajax({
      method: 'GET',
      url: '/messages',
      success: function (data) {
        console.log('TEST test_unauthorized FAIL');
      },
      error: function (data) {
        console.log('TEST test_unauthorized SUCCESS');
      }
    });
  }

  function test_show_account(user_id) {
    $.ajax({
      method: 'GET',
      url: '/users/' + user_id,
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        if (typeof data.password != 'undefined')
          console.log('TEST test_show_account FAILED', 'contains password field');
        else if (data.email != username || data.location != 'Paris')
          console.log('TEST test_show_account FAILED', 'values mismatch');
        else
          console.log('TEST test_show_account SUCCESS');
      },
      error: function (data) {
        console.log('TEST test_show_account FAILED', data);
      }
    });
  }

  function test_create_account() {
    user_data = {
      email: username,
      first_name: "Francis",
      last_name: "Huster",
      password: "lepassword",
      location: "Paris",
      about: "Acteur en perdition"
    };
    $.ajax({
      method: 'POST',
      url: '/users',
      data: JSON.stringify(user_data),
      contentType: 'application/json',
      dataType: 'json',
      success: function(data) {
        console.log('TEST test_create_account SUCCESS', data);
        test_show_account(data.id);
        test_session();
      },
      error: function(data) {
        console.log('TEST test_create_account FAILURE', data);
      }
    });
  }

  $(document).ready(function() {
    test_create_account();
    test_unauthorized();
  });

  </script>
</head>
  <body>
  </body>
</html>
